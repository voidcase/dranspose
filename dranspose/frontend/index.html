<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<script>

// init

function drawProgressBar(data) {
  if (data.total_events === 0) {
    document.getElementById("progressComplete").style.width = "0";
    document.getElementById("progressAssigned").style.width = "0";
    return
  }
  const percentageComplete = data.completed_events / data.total_events * 100
  const percentageAssignedIncomplete = (data.last_assigned - data.completed_events) / data.total_events * 100
  document.getElementById("progressComplete").style.width = `${percentageComplete}%`;
  document.getElementById("progressAssigned").style.width = `${percentageAssignedIncomplete}%`;
  document.getElementById("completeLabel").innerHTML = `
    ${data.completed_events}/${data.total_events} events complete.
    last assigned: ${data.last_assigned}
  `
}

function renderTable(entries, headers, headerMap = (row, header) => row[header] , rowStyler = (row) => "") {
  if (!Array.isArray(entries) || entries.length === 0) return "<p>No data available.</p>";

  const thead = `
    <thead>
      <tr>
        ${headers.map(header => `<th>${header}</th>`).join('')}
      </tr>
    </thead>
  `;

  const tbody = `
    <tbody>
      ${entries.map(log => `
        <tr style=${rowStyler(log)};">
          ${headers.map(header => {
            let value = headerMap(log, header);
            return `<td>${value}</td>`;
          }).join('')}
        </tr>
      `).join('')}
    </tbody>
  `;

  return `<table border=1 style="border-collapse: collapse;">${thead}${tbody}</table>`;
}

function renderLogTable(entries) {
  const colorMap = {WARNING: "#c5c226", ERROR: "#e26f4d", CRITICAL: "#f00"}
  const headers = ["created", "levelname", "name", "lineno", "msg"];
  const headerMap = (row, header) => {
      if (header === "created") {
        return new Date(parseFloat(row[header]) * 1000).toLocaleString();
      }
      if (header === "msg") {
        return `<pre>${row.msg}</pre>`
      }
      return row[header]
    }
  const rowStyler = (entry) => `background-color:${ colorMap[entry.levelname] || "#fff" }`
  return renderTable(entries, headers, headerMap, rowStyler)
}


async function update() {
  try {
    const resp = await fetch("/api/v1/progress");
    const datap = await resp.json();
    drawProgressBar(datap)
    document.querySelector(`#progress`).innerHTML = JSON.stringify(datap, null, 2);

    const res = await fetch("/api/v1/config");
    const data = await res.json();
    console.log(data);
    document.querySelector(`#ingesters`).innerHTML = renderTable(data.ingesters, [
      "name", "event_rate", "processed_events", "url", "streams",
    ]);
    document.querySelector(`#workers`).innerHTML = renderTable(data.workers, [
      "name", "event_rate", "processed_events", "tags",
    ]);
    document.querySelector(`#reducer`).innerHTML = renderTable([data.reducer], [
      "name", "event_rate", "processed_events", "url",
    ]);

    const resl = await fetch("/api/v1/logs?level=INFO");
    const datal = (await resl.json()).reverse();
    document.querySelector(`#logs`).innerHTML = renderLogTable(datal);
  } catch (e) {
    console.log("unable to fetch", e)
  }

  setTimeout(update, 5000); // update every 15 seconds?
}

update();
</script>
<h2>Progress</h2>
<div class="progressContainer">
  <div id="progressBar">
    <div id="progressComplete"></div>
    <div id="progressAssigned"></div>
  </div>
  <div id="completeLabel"></div>
</div>
<pre id="progress"></pre>
<h2>Configuration</h2>

<h3>Ingesters</h3>
<div id="ingesters"></div>
<h3>Workers</h3>
<div id="workers"></div>
<h3>Reducer</h3>
<div id="reducer"></div>
<h3>Logs</h3>
<div id="logs"></div>

<style>
#progressBar {
  width: 98%;
  height: 50px;
  background-color: #d3d4c1;
  padding: 2px;
  border: solid 2px;
  margin: auto;
}
#progressComplete {
  background-color: green;
  text-align: right;
  height: 100%;
  float: left;
  color: #d3d4c1;
}
#progressAssigned {
  background-color: #c3ca46;
  height: 100%;
  float: left;
  text-align: right;
}
</style>
</body>
</html>
